<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Annielytics Model Picker for AI Projects</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicon -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon.png') }}">

    <!-- CSS -->
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- vis-network CSS from unpkg -->
    <link rel="stylesheet" href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css" />

    <!-- Tailwind -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- My CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

    <!-- Initialize network data -->
    <script>
        window.networkData = {% if network_data %}{{ network_data | safe }}{% else %}null{% endif %};

        // Handle url parameters immediately
        if (window.location.search) {
            document.addEventListener('DOMContentLoaded', function() {
                const resultsContainer = document.getElementById('results');
                if (resultsContainer) {
                    console.log('Showing results container due to URL parameters');
                    resultsContainer.classList.remove('hidden');
                }
            });
        }
    </script>
</head>

<body>
    <div class="container-fluid"> 

        <!-- Header Container -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Model Picker for AI Projects</h1>
            <img src="{{ url_for('static', filename='img/annielytics-logo.png') }}" alt="Annielytics Logo" class="header-logo">
        </div>

        <!-- Model Picker Form -->
        <h2> Step 1: Let's get some information about your model's purpose</h2>
        <form id="modelPickerForm">
            <section class="form-section">

                <!-- Tasks -->
                <h3>What tasks will your AI app perform? <span class="info-icon" data-tooltip="You can select more than one task. If there's a task you'd like to suggest, please fill out the form below.">ⓘ</span></h3>
                <div class="checkbox-group">
                    <label class="checkbox-option">
                        <input type="checkbox" name="tasks" value="Chain agents">
                        <span class="checkbox-text">Chain agents</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="tasks" value="Chat">
                        <span class="checkbox-text">Chat</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="tasks" value="Convert speech to text">
                        <span class="checkbox-text">Convert speech to text</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="tasks" value="Convert text to speech">
                        <span class="checkbox-text">Convert text to speech</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="tasks" value="Generate code">
                        <span class="checkbox-text">Generate code</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="tasks" value="Generate images">
                        <span class="checkbox-text">Generate images</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="tasks" value="Generate text">
                        <span class="checkbox-text">Generate text</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="tasks" value="Generate video">
                        <span class="checkbox-text">Generate video</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="tasks" value="Solve complex problems">
                        <span class="checkbox-text">Solve complex problems</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="tasks" value="Solve math problems">
                        <span class="checkbox-text">Solve math problems</span>
                    </label>
                </div>
            </section>

            <!-- Goals -->
            <section id="goalsSection" class="form-section">
                <h3>What benchmarks do you want to compare?</h3>
                <div class="checkbox-group">
                    <label class="checkbox-option">
                        <input type="checkbox" name="goals" value="Quality">
                        <span class="checkbox-text">Quality</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="goals" value="Cost">
                        <span class="checkbox-text">Cost</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="goals" value="Speed">
                        <span class="checkbox-text">Speed</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="goals" value="Latency">
                        <span class="checkbox-text">Latency</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="goals" value="Context window">
                        <span class="checkbox-text">Context window</span>
                    </label>
                </div>
            </section>
            <button type="submit" class="submit-button">Compare models</button>
        </form>

    <!-- Results Container -->
    <div id="results" class="results-container hidden">
        <h2>Step 2: Find benchmarks appropriate to compare models against <span class="info-icon" data-tooltip="...long tooltip text...">ⓘ</span></h2>
       
        <!-- Slider Container -->
        <div class="slider-container">
            <label for="node-spacing-slider" class="d-block">Set zoom level:</label>
            <div class="slider-with-signs">
                <div class="signs-container">
                    <span class="zoom-sign minus">−</span>
                    <span class="zoom-sign plus">+</span>
                </div>
                <!-- Set Slider Range -->
                <input type="range" id="node-spacing-slider" min="0.5" max="2" step="0.1" value="1">
            </div>
        </div>

        <!-- Network Container -->
        <div class="network-container">
            <div id="network-container">
                {{ graph_body | safe }}
            </div>
            <div id="resizer"></div>  <!-- CHANGED: Just a handle with no inline styling -->
        </div>

        <!-- Modal Container -->
            <div id="leaderboard-container"></div>

        <!-- Check if the leaderboard modal container exists -->
        <script>console.log('Container exists:', !!document.getElementById('leaderboard-container'));</script>

        <!-- Dependencies in order -->

        <!-- 1. React and Babel -->
        <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <!-- 2. jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <!-- 3. vis-network JavaScript -->
        <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>

        <!-- Check if vis is loaded -->
        <script>
            console.log('After loading vis-network, vis is:', typeof vis);
        </script>

        <!-- 4. My network.js (which uses vis) -->
        <script src="{{ url_for('static', filename='js/network.js') }}"></script>

        <!-- 5. My leaderboard modal component (inline now)
        <script type="text/babel" src="/static/js/components/leaderboard_modal.jsx"></script>  -->  

        <!-- React Component Container -->
        {% raw %}
        <script type="text/babel">
            console.log('Starting React initialization');
            
            function LeaderboardModal() {
                const [isOpen, setIsOpen] = React.useState(false);
                const [data, setData] = React.useState(null);
                
                console.log('LeaderboardModal rendered, isOpen:', isOpen, 'data:', data);

                React.useEffect(() => {
                    console.log('Adding leaderboardClick listener');
                    
                    function handleLeaderboardClick(event) {
                        console.log('LeaderboardClick event received in React:', event.detail);
                        
                        // Hide any visible tooltips when modal opens
                        const tooltip = document.querySelector('.vis-tooltip');
                        if (tooltip) {
                            tooltip.style.visibility = 'hidden';
                            tooltip.style.opacity = '0';
                        }
                        
                        fetch('/filter_data', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ node_id: event.detail.nodeId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Received data:', data);
                            setData(data);
                            setIsOpen(true);
                        })
                        .catch(error => console.error('Error:', error));
                    }

                    window.addEventListener('leaderboardClick', handleLeaderboardClick);
                    console.log('Event listener added');
                    
                    return () => {
                        window.removeEventListener('leaderboardClick', handleLeaderboardClick);
                        console.log('Event listener removed');
                    };
                }, []);

                if (!isOpen || !data) return null;

                // External link icon component
                const ExternalLinkIcon = () => (
                    <span className="inline-block ml-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" 
                            stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                            <polyline points="15 3 21 3 21 9" />
                            <line x1="10" y1="14" x2="21" y2="3" />
                        </svg>
                    </span>
                );

                return (
                    <div 
                        className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                        onClick={() => setIsOpen(false)}
                    >
                        <div 
                            className="bg-white p-6 rounded-lg shadow-lg max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto"
                            onClick={e => e.stopPropagation()}
                        >
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold">{data.leaderboard}</h2>
                                <button 
                                    onClick={() => setIsOpen(false)}
                                    className="text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                >
                                    ×
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {/* Column 1: Basic Info */}
                                <div className="space-y-4">
                                    <div>
                                        <h3 className="font-bold mb-2">Leaderboard</h3>
                                        <p>{data.leaderboard}</p>
                                        {data.leaderboard_link && (
                                            <a 
                                                href={data.leaderboard_link} 
                                                target="_blank" 
                                                rel="noopener noreferrer"
                                                className="text-blue-600 hover:text-blue-800 inline-flex items-center mt-2"
                                            >
                                                View leaderboard
                                                <ExternalLinkIcon />
                                            </a>
                                        )}
                                    </div>
                                    <div>
                                        <h3 className="font-bold mb-2">Summary</h3>
                                        <p>{data.tooltip}</p>
                                    </div>
                                    <div>
                                        <h3 className="font-bold mb-2">Methodology</h3>
                                        {data.url && (
                                            <a 
                                                href={data.url} 
                                                target="_blank" 
                                                rel="noopener noreferrer"
                                                className="text-blue-600 hover:text-blue-800 inline-flex items-center"
                                            >
                                                View methodology
                                                <ExternalLinkIcon />
                                            </a>
                                        )}
                                    </div>
                                </div>

                                {/* Column 2: Tips */}
                                <div>
                                    <h3 className="font-bold mb-2">Tips</h3>
                                    {data.analysis_tips && (
                                        <ul className="list-disc pl-4 space-y-2">
                                            {data.analysis_tips.map((tip, index) => (
                                                <li key={index}>{tip}</li>
                                            ))}
                                        </ul>
                                    )}
                                </div>

                                {/* Column 3: Benchmarks */}
                                <div>
                                    <h3 className="font-bold mb-2">Benchmark(s)</h3>
                                    <div className="space-y-4">
                                        {data.benchmarks && Object.entries(data.benchmarks).map(([name, details], index) => (
                                            <div key={index} className="pb-2 border-b border-gray-200 last:border-0">
                                                <p className="font-semibold">{name}</p>
                                                <p>{details.measures} <span className="text-gray-600">({details.score_interpretation})</span></p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Wait for both DOM and React to be ready
            function initReact() {
                console.log('Checking React initialization requirements');
                
                const container = document.getElementById('leaderboard-container');
                if (!container) {
                    console.error('Container not found!');
                    return;
                }
                
                if (!React || !ReactDOM) {
                    console.error('React not loaded yet');
                    setTimeout(initReact, 100);
                    return;
                }
                
                console.log('All requirements met, initializing React');
                const root = ReactDOM.createRoot(container);
                root.render(<LeaderboardModal />);
                console.log('Component rendered');
            }

            // Start initialization when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initReact);
            } else {
                initReact();
            }
        </script>
        {% endraw %}

        <!-- Submit form -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('modelPickerForm');
                const resultsContainer = document.getElementById('results');
                
                // Set initial checkbox states based on URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                
                // Set tasks checkboxes
                const selectedTasks = urlParams.getAll('tasks');
                document.querySelectorAll('input[name="tasks"]').forEach(checkbox => {
                    checkbox.checked = selectedTasks.includes(checkbox.value);
                });
                
                // Set goals checkboxes
                const selectedGoals = urlParams.getAll('goals');
                document.querySelectorAll('input[name="goals"]').forEach(checkbox => {
                    checkbox.checked = selectedGoals.includes(checkbox.value);
                });
                
                let retryCount = 0;
                const MAX_RETRIES = 5;
                
                // Function to handle network initialization
                const initializeNetworkWithRetry = async () => {
                    try {
                        // Check if we've exceeded max retries
                        if (retryCount >= MAX_RETRIES) {
                            throw new Error('Maximum retry attempts reached. Please refresh the page.');
                        }

                        // Wait for vis-network to be available
                        if (typeof vis === 'undefined') {
                            throw new Error('Waiting for vis-network to load...');
                        }
                        
                        // Check if we have network data
                        if (!window.networkData) {
                            throw new Error('Network data not available yet...');
                        }
                        
                        // Initialize the network
                        initializeNetwork();
                        
                        // Reset retry count on success
                        retryCount = 0;
                        
                    } catch (error) {
                        console.warn(`Network initialization attempt ${retryCount + 1} failed:`, error);
                        
                        // Show error message in the network container
                        const container = document.getElementById('network-container');
                        if (container) {
                            container.innerHTML = `
                                <div style="text-align: center; padding: 20px;">
                                    <p>Network initialization failed. ${retryCount < MAX_RETRIES ? 'Retrying...' : 'Max retries reached.'}</p>
                                    <p style="color: red;">${error.message}</p>
                                </div>
                            `;
                        }
                        
                        // Increment retry count
                        retryCount++;
                        
                        // Only retry if we haven't exceeded max retries
                        if (retryCount < MAX_RETRIES) {
                            setTimeout(initializeNetworkWithRetry, 1000);
                        }
                    }
                };
        
                // Function to collect form data and build query string
                function getFormQueryString() {
                    const formData = new FormData(form);
                    const params = new URLSearchParams();
                    
                    // Collect all selected tasks
                    const tasks = formData.getAll('tasks');
                    tasks.forEach(task => params.append('tasks', task));
                    
                    // Collect all selected goals
                    const goals = formData.getAll('goals');
                    goals.forEach(goal => params.append('goals', goal));
                    
                    return params.toString();
                }

                // If the URL has parameters, show results and initialize the network
                if (window.location.search) {
                    console.log('URL parameters detected:', window.location.search);
                    resultsContainer.classList.remove('hidden');
                    console.log('Hidden class removed from results container');
                    initializeNetworkWithRetry();
                }
        
                // Add validation message container after the form
                const validationMessage = document.createElement('div');
                validationMessage.classList.add('alert', 'alert-danger', 'd-none');
                validationMessage.style.marginTop = '1rem';
                form.insertAdjacentElement('afterend', validationMessage);

                form.addEventListener('submit', function(e) {
                    e.preventDefault(); // Prevent default form submission
                    
                    // Get selected tasks and goals
                    const selectedTasks = form.querySelectorAll('input[name="tasks"]:checked');
                    const selectedGoals = form.querySelectorAll('input[name="goals"]:checked');
                    
                    // Validate selections
                    if (selectedTasks.length === 0 || selectedGoals.length === 0) {
                        validationMessage.classList.remove('d-none');
                        validationMessage.textContent = 'Please select at least one task and one benchmark to compare.';
                        return;
                    }
                    
                    // Hide validation message if it exists
                    validationMessage.classList.add('d-none');
                    
                    // Build query string from form data
                    const queryString = getFormQueryString();
                    
                    // Update URL with new parameters
                    const newUrl = `${window.location.pathname}?${queryString}`;
                    window.history.pushState({}, '', newUrl);
                    
                    // Show results and initialize network
                    resultsContainer.classList.remove('hidden');
                    
                    // Reload the page to trigger Flask route with new parameters
                    window.location.reload();
                });
            });
        </script>
    </div>   
</body>
</html>